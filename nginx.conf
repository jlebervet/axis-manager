# =============================================================================
# CONFIGURATION NGINX POUR AXIS MANAGER
# =============================================================================
# Ce fichier configure Nginx pour :
# 1. Servir les fichiers statiques du frontend React (HTML, CSS, JS, images)
# 2. Router les requêtes /api/* vers le backend FastAPI (reverse proxy)
# 3. Gérer les erreurs et les logs
# =============================================================================

# Configuration globale de Nginx
user appuser;
worker_processes auto;
pid /var/run/nginx.pid;

# Configuration des événements (connexions)
events {
    # Nombre maximum de connexions simultanées par worker
    worker_connections 1024;
}

# Configuration HTTP
http {
    ##
    ## Types MIME et paramètres de base
    ##
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    ##
    ## Configuration des logs
    ##
    # Format des logs d'accès : qui accède, quand, quelle ressource, quel code de réponse
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    # Envoyer les logs vers la sortie standard (visible dans docker logs)
    access_log /dev/stdout main;
    error_log /dev/stderr warn;

    ##
    ## Optimisations de performance
    ##
    # sendfile : Utilise l'appel système sendfile() pour un transfert de fichier plus efficace
    sendfile on;

    # tcp_nopush : Optimise l'envoi de paquets TCP (envoie les headers et le début du fichier ensemble)
    tcp_nopush on;

    # tcp_nodelay : Désactive l'algorithme de Nagle pour réduire la latence
    tcp_nodelay on;

    # Temps maximum avant de fermer une connexion keep-alive inactive
    keepalive_timeout 65;

    # Limite de taille pour les noms de hash de types
    types_hash_max_size 2048;

    ##
    ## Compression Gzip pour réduire la taille des fichiers transférés
    ##
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript
               application/json application/javascript application/xml+rss
               application/rss+xml font/truetype font/opentype
               application/vnd.ms-fontobject image/svg+xml;

    ##
    ## Configuration du serveur principal
    ##
    server {
        # Écouter sur le port 80 (HTTP standard)
        listen 80;
        listen [::]:80;

        # Nom du serveur (accepte toutes les requêtes)
        server_name _;

        # Racine des fichiers statiques du frontend React
        root /app/frontend/build;

        # Fichier index par défaut
        index index.html;

        # Taille maximale du corps de requête (pour l'upload de fichiers audio)
        # Augmentée à 100MB pour permettre l'upload de fichiers audio volumineux
        client_max_body_size 100M;

        ##
        ## BLOC 1 : Routes API (Backend FastAPI)
        ##
        # Toutes les requêtes commençant par /api/ sont envoyées au backend Uvicorn
        location /api/ {
            # Proxy vers le backend FastAPI qui tourne sur le port 8001
            proxy_pass http://localhost:8001;

            # Headers nécessaires pour que le backend connaisse l'origine de la requête
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Timeouts pour les requêtes longues (découverte de speakers, etc.)
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        ##
        ## BLOC 2 : Fichiers statiques du frontend React
        ##
        # Essaie de servir le fichier demandé, sinon renvoie index.html
        # Cela permet au React Router de gérer les routes côté client
        location / {
            try_files $uri $uri/ /index.html;
        }

        ##
        ## BLOC 3 : Cache des fichiers statiques
        ##
        # Les fichiers avec hash dans le nom (générés par React) peuvent être cachés longtemps
        location ~* \.(?:css|js|jpg|jpeg|gif|png|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            access_log off;
        }

        ##
        ## BLOC 4 : Désactiver le cache pour index.html
        ##
        # index.html ne doit jamais être caché pour que les mises à jour soient immédiates
        location = /index.html {
            expires -1;
            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
        }

        ##
        ## BLOC 5 : Page d'erreur personnalisée
        ##
        # En cas d'erreur 404, renvoie index.html pour que React Router gère
        error_page 404 /index.html;

        # En cas d'erreur serveur 500, afficher une page d'erreur simple
        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            root /usr/share/nginx/html;
        }
    }
}
